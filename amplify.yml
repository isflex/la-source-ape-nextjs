version: 1
applications:
  -
    backend:
      phases:
        preBuild:
          commands:
            # - 'nvm install 20.19.1'
            # - 'nvm use 20.19.1'
            # https://docs.aws.amazon.com/amplify/latest/userguide/custom-build-image.html#setup-live-updates
            # - node -v
            - pwd
            - sudo fallocate -l 40G /swapfile
            - sudo chmod 600 /swapfile
            - sudo mkswap /swapfile
            - sudo swapon /swapfile
            - sudo swapon -s
            - npm install --cache .npm --prefer-offline
        build:
          commands:
            - npx ampx info
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
      cache:
        paths:
          - '.npm/**/*'
          - 'node_modules/**/*'
    frontend:
      buildPath: apps/gateway
      phases:
        preBuild:
          commands:
            # - 'nvm install 20.19.1'
            # - 'nvm use 20.19.1'
            # https://docs.aws.amazon.com/amplify/latest/userguide/custom-build-image.html#setup-live-updates
            # - node -v
            - pwd
            # - rm -rf .next
            - cd ../../ # run install and build from monorepo project root
            - pwd
            # - npm install -g pnpm
            - npm install --global corepack@latest
            - corepack enable
            - corepack prepare pnpm@latest-10 --activate
            # - mkdir ../.pnpm-store
            # - pnpm config set store-dir ../.pnpm-store
            - pnpm install --frozen-lockfile
            - pnpm store path
            - pnpm list react*
        build:
          commands:
            - pwd
            - export FLEX_PROJ_ROOT=$(pwd)
            - pnpm build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - '.next/cache/**/*'
          - 'apps/gateway/.next/cache/**/*'
          - 'node_modules/**/*'
    appRoot: apps/gateway
